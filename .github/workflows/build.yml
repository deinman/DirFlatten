name: Build Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore DirFlatten/DirFlatten.csproj

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.4.x'

      - name: GitVersion
        uses: gittools/actions/gitversion/execute@v4
        id: gitversion
        
      - name: Set version environment variables
        shell: bash
        run: |
          # Use GitVersion outputs for all versioning
          version="${{ steps.gitversion.outputs.semVer }}"
          fullVersion="${{ steps.gitversion.outputs.fullSemVer }}"
  
          # Assembly version must be 4-part (x.y.z.w)
          assemblyVersion="${{ steps.gitversion.outputs.major }}.${{ steps.gitversion.outputs.minor }}.${{ steps.gitversion.outputs.patch }}.0"
  
          echo "Using semantic version: $version"
          echo "Using full version: $fullVersion"
          echo "Using assembly version: $assemblyVersion"
  
          echo "VERSION=$version" >> "$GITHUB_ENV"
          echo "FULLVERSION=$fullVersion" >> "$GITHUB_ENV"
          echo "ASSEMBLY_VERSION=$assemblyVersion" >> "$GITHUB_ENV"

      - name: Build x64
        run: |
          dotnet publish DirFlatten/DirFlatten.csproj \
            -c Release \
            -r linux-x64 \
            /p:DebugType=None \
            /p:DebugSymbols=false \
            /p:Version="$VERSION" \
            /p:AssemblyVersion="$ASSEMBLY_VERSION" \
            /p:FileVersion="$ASSEMBLY_VERSION" \
            /p:AssemblyInformationalVersion="$FULLVERSION" \
          
      - name: Prepare artifacts
        shell: bash
        run: |
          # Create artifacts directory
          mkdir -p artifacts
          
          # Use VERSION environment variable (calculated via GitVersion)
          version="$VERSION"
          
          # Create TAR.GZ files with exe
          mkdir -p temp-x64
          cp "DirFlatten/bin/Release/net10.0/linux-x64/publish/DirFlatten" temp-x64/
          
          tar -czf "artifacts/DirFlatten-v$version-linux-x64.tar.gz" -C temp-x64 .
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DirFlatten-linux-x64
          path: artifacts/*.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.tar.gz
          body: |
            ## DirFlatten ${{ github.ref_name }}
            
            A simple console application to flatten a folder that contains directories with single files.
            
            Created by Daniel Inman
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}